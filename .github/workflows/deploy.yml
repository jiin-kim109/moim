name: Deploy

on:
  release:
    types: [published, prereleased]

jobs:
  update-version:
    runs-on: ubuntu-latest
    
    outputs:
      version-updated: ${{ steps.version-check.outputs.updated }}
      tag-name: ${{ steps.extract-tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract tag name
        id: extract-tag
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Extracted tag: $TAG_NAME"

      - name: Validate tag format and check version
        id: version-check
        run: |
          TAG_NAME="${{ steps.extract-tag.outputs.tag }}"
          
          # Validate tag format (should be semantic version like 1.0.1)
          if ! echo "$TAG_NAME" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Tag '$TAG_NAME' is not a valid semantic version (e.g., 1.0.1)"
            exit 1
          fi
          
          # Read current version from app.config.js using grep and sed
          CURRENT_VERSION=$(grep -o 'version: "[^"]*"' app.config.js | sed 's/version: "\(.*\)"/\1/')
          
          echo "Current version in app.config.js: $CURRENT_VERSION"
          echo "Tag version: $TAG_NAME"
          
          # Function to compare versions (returns 0 if tag > current, 1 if tag <= current)
          compare_versions() {
            local tag_version=$1
            local current_version=$2
            
            # Convert versions to arrays
            IFS='.' read -ra TAG_PARTS <<< "$tag_version"
            IFS='.' read -ra CURRENT_PARTS <<< "$current_version"
            
            # Compare major, minor, patch
            for i in 0 1 2; do
              tag_part=${TAG_PARTS[i]:-0}
              current_part=${CURRENT_PARTS[i]:-0}
              
              if [ "$tag_part" -gt "$current_part" ]; then
                return 0  # tag > current
              elif [ "$tag_part" -lt "$current_part" ]; then
                return 1  # tag < current
              fi
            done
            
            return 1  # tag == current
          }
          
          if compare_versions "$TAG_NAME" "$CURRENT_VERSION"; then
            echo "Version check passed. Tag version ($TAG_NAME) is higher than current version ($CURRENT_VERSION)"
            echo "updated=true" >> $GITHUB_OUTPUT
          elif [ "$TAG_NAME" = "$CURRENT_VERSION" ]; then
            echo "Version already matches. Tag version ($TAG_NAME) equals current version ($CURRENT_VERSION). Skipping update."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "Error: Tag version ($TAG_NAME) is lower than current version ($CURRENT_VERSION)"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Update version in app.config.js
        if: steps.version-check.outputs.updated == 'true'
        run: |
          TAG_NAME="${{ steps.extract-tag.outputs.tag }}"
          
          # Update version in app.config.js using sed
          sed -i "s/version: \"[^\"]*\"/version: \"$TAG_NAME\"/" app.config.js
          echo "Updated version to $TAG_NAME in app.config.js"

      - name: Commit version update
        if: steps.version-check.outputs.updated == 'true'
        run: |
          TAG_NAME="${{ steps.extract-tag.outputs.tag }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add app.config.js
          git commit -m "chore: bump version to $TAG_NAME"
          git push origin HEAD

      - name: Output success
        if: steps.version-check.outputs.updated == 'true'
        run: |
          echo "âœ… Version successfully updated to ${{ steps.extract-tag.outputs.tag }}"

  # Build iOS APP
  build-ios:
    needs: update-version
    if: always() && needs.update-version.result == 'success'
    runs-on: macos-latest
    
    outputs:
      build-profile: ${{ steps.get-version.outputs.build_profile }}
      version: ${{ steps.get-version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get latest changes after version update
        run: |
          git pull origin main

      - name: Get current version and check release type
        id: get-version
        run: |
          # Read version from app.config.js (already updated by previous job)
          VERSION=$(grep -o 'version: "[^"]*"' app.config.js | sed 's/version: "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if this is a pre-release
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "Building pre-release version: $VERSION"
            echo "build_profile=development" >> $GITHUB_OUTPUT
          else
            echo "Building production version: $VERSION"
            echo "build_profile=production" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_ACCESS_TOKEN }}

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build iOS app
        run: |
          eas build --platform ios --profile ${{ steps.get-version.outputs.build_profile }} --local --non-interactive

      - name: Find build artifact
        id: find-artifact
        run: |
          BUILD_PROFILE="${{ steps.get-version.outputs.build_profile }}"
          
          if [ "$BUILD_PROFILE" = "production" ]; then
            # Find the most recent .ipa file for production builds
            ARTIFACT_FILE=$(find . -name "*.ipa" -type f -exec ls -la {} \; | sort -k 6,7 | tail -n 1 | awk '{print $NF}')
          else
            # Find the most recent .tar.gz file for development builds
            ARTIFACT_FILE=$(find . -name "*.tar.gz" -type f -exec ls -la {} \; | sort -k 6,7 | tail -n 1 | awk '{print $NF}')
          fi
          
          if [ -z "$ARTIFACT_FILE" ]; then
            echo "Error: No build artifact found for $BUILD_PROFILE profile"
            exit 1
          fi
          
          echo "artifact_path=$ARTIFACT_FILE" >> $GITHUB_OUTPUT
          echo "artifact_name=$(basename $ARTIFACT_FILE)" >> $GITHUB_OUTPUT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ steps.get-version.outputs.build_profile }}-${{ steps.get-version.outputs.version }}
          path: ${{ steps.find-artifact.outputs.artifact_path }}
          retention-days: 30

      - name: Output build success
        run: |
          echo "ðŸ“¦ Artifact uploaded: ${{ steps.find-artifact.outputs.artifact_name }}"

  # Deploy iOS APP (only for production builds)
  deploy-ios:
    needs: [update-version, build-ios]
    if: always() && needs.build-ios.result == 'success' && needs.build-ios.outputs.build-profile == 'production'
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get latest changes after version update
        run: |
          git pull origin main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: get-version
        run: |
          # Read version from app.config.js (already updated by previous job)
          VERSION=$(grep -o 'version: "[^"]*"' app.config.js | sed 's/version: "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-build-production-${{ needs.build-ios.outputs.version }}
          path: ./

      - name: Find downloaded IPA file
        id: find-ipa
        run: |
          # For production builds, we know it's an .ipa file
          IPA_FILE=$(find . -name "*.ipa" -type f | head -n 1)
          
          if [ -z "$IPA_FILE" ]; then
            echo "Error: No .ipa file found in artifacts"
            exit 1
          fi
          
          echo "Found IPA file: $IPA_FILE"
          echo "ipa_path=$IPA_FILE" >> $GITHUB_OUTPUT

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_ACCESS_TOKEN }}

      - name: Submit to App Store
        env:
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
        run: |
          echo "ðŸ“¤ Submitting to App Store..."
          eas submit -p ios --non-interactive --path "${{ steps.find-ipa.outputs.ipa_path }}"

      - name: Output deploy success
        run: |
          echo "âœ… iOS app successfully submitted to App Store for version: ${{ needs.build-ios.outputs.version }}"
          echo "ðŸŽ‰ Deployment completed successfully!"

  # Deploy Android APP
  # deploy-android:
  #   needs: update-version
  #   if: needs.update-version.outputs.version-updated == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Deploy Android
  #       run: echo "Android deployment will be implemented later"
